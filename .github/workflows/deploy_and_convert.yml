name: Deploy and Convert (stag)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:                # top-level env (static only)
  AWS_REGION:    us-east-2
  ECR_REGISTRY:  703671891952.dkr.ecr.us-east-2.amazonaws.com
  ECR_REPOSITORY: projectplace-lambda
  STAGE_TAG:     stag

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest
    env:        # derived vars belong here (or inside a single step)
      IMAGE_TAG: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.STAGE_TAG }}

    steps:
      - uses: actions/checkout@v3

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: ğŸ³ Login to ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION |
            docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: ğŸ›  Build & push
        run: |
          docker buildx build \
            --no-cache --pull \
            --platform linux/amd64 \
            --build-arg USE_TAG_HANDLER=true \
            -t projectplace-lambda:latest \
            -t $IMAGE_TAG \
            --push .


    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Update Lambda code â”€â”€â”€â”€
    - name: ğŸš€ Update Lambda to latest image
      run: |
        set -euo pipefail
        aws lambda update-function-code \
          --function-name ProjectPlaceDataExtractor-stag \
          --image-uri "$IMAGE_TAG" \
          --region "$AWS_REGION"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Wait for code update â”€â”€
    - name: â³ Wait for code update to finish
      run: |
        aws lambda wait function-updated \
          --function-name ProjectPlaceDataExtractor-stag \
          --region "$AWS_REGION"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Merge env-vars â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: ğŸ§¬ Merge & apply env-vars
      run: |
        set -euo pipefail
        OLD=$(aws lambda get-function-configuration \
               --function-name ProjectPlaceDataExtractor-stag \
               --query 'Environment.Variables' --output json)

        NEW=$(echo "$OLD" | jq \
          --arg secret ProjectPlaceAPICredentials \
          --arg ddb   ProjectPlace_DataExtrator_landing_table_v3 \
          --arg s3    projectplace-dv-2025-x9a7b \
          '. + {
             SECRET_NAME:        $secret,
             DYNAMODB_TABLE_NAME:$ddb,
             S3_BUCKET_NAME:     $s3
           }')

        echo '{"Variables":'"$NEW"'}' > env.json

        aws lambda update-function-configuration \
          --function-name ProjectPlaceDataExtractor-stag \
          --environment file://env.json \
          --region "$AWS_REGION"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Wait for env update â”€â”€â”€
    - name: â³ Wait for env update
      run: |
        aws lambda wait function-updated \
          --function-name ProjectPlaceDataExtractor-stag \
          --region "$AWS_REGION"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Smoke test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” One-shot Lambda invoke (async)
      run: |
        aws lambda invoke \
          --function-name ProjectPlaceDataExtractor-stag \
          --invocation-type Event \
          --payload '{}' \
          --region "$AWS_REGION" \
          /tmp/out.json
        echo "Lambda triggered â†’ $(cat /tmp/out.json)"

#####################################################################
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) Convert DOCX â†’ PDF job â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#####################################################################
  convert-docx:
    runs-on: ubuntu-latest
    needs: [ deploy-lambda ]

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:            ${{ env.AWS_REGION }}

    - name: ğŸ— Install LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice

    - name: ğŸ“¥ Wait and download Acta_*.docx from S3
      run: |
        mkdir -p actas
        for i in {1..15}; do
          echo "â³ Attempt $i: checking for 'Acta_*.docx' in S3..."
          aws s3 sync \
            s3://projectplace-dv-2025-x9a7b/actas actas \
            --exclude "*" --include "Acta_*.docx" --delete
          COUNT=$(ls -1 actas/Acta_*.docx 2>/dev/null | wc -l)
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ… Found $COUNT .docx file(s)."
            break
          fi
          echo "ğŸ”„ Not ready. Sleeping 20 sâ€¦"
          sleep 20
          [ "$i" -eq 15 ] && { echo "âŒ Timeout (5 min)"; exit 1; }
        done

    - name: ğŸ–¨ Convert each .docx â‡’ .pdf
      run: |
        cd actas
        for f in Acta_*.docx; do
          libreoffice --headless --convert-to pdf "$f"
        done

    - name: ğŸš€ Upload .pdf files back to S3
      run: |
        aws s3 sync actas s3://projectplace-dv-2025-x9a7b/actas \
          --exclude "*" --include "Acta_*.pdf" \
          --content-type "application/pdf" \
          --content-disposition "attachment"
