name: Convert Latest Docx to PDF

on:
  workflow_dispatch: {}  # Allows manual trigger in GitHub Actions

jobs:
  convert-latest-docx:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout source
        uses: actions/checkout@v3

      - name: 🔐 Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2  # update if needed

      - name: 🏗 Install LibreOffice
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice

      - name: 🔎 Find the latest .docx in S3
        id: find_latest
        run: |
          # This list-objects query returns only items that end with ".docx"
          # Then sorts them by LastModified, reversed, and picks the first (the newest)
          LATEST_DOC=$(aws s3api list-objects-v2 \
            --bucket projectplace-dv-2025-x9a7b \
            --prefix "actas/" \
            --query "reverse(sort_by(Contents[?ends_with(Key, '.docx')], &LastModified))[0].Key" \
            --output text)

          if [ "$LATEST_DOC" = "None" ] || [ -z "$LATEST_DOC" ]; then
            echo "No .docx file found in s3://projectplace-dv-2025-x9a7b/actas/"
            exit 1
          fi

          echo "LATEST_DOC=$LATEST_DOC"
          # Expose the doc key as an output for later steps
          echo "LATEST_DOC=$LATEST_DOC" >> $GITHUB_OUTPUT

      - name: 📂 Download the newly created docx
        run: |
          DOCX_NAME=${{ steps.find_latest.outputs.LATEST_DOC }}
          echo "Downloading s3://projectplace-dv-2025-x9a7b/$DOCX_NAME"

          LOCAL_DOCX=$(basename "$DOCX_NAME")
          aws s3 cp "s3://projectplace-dv-2025-x9a7b/$DOCX_NAME" "$LOCAL_DOCX"

          echo "Verifying it downloaded..."
          ls -l

      - name: 🖨 Convert docx to pdf
        run: |
          DOCX_FILE=$(ls *.docx)
          echo "Converting $DOCX_FILE to PDF..."

          libreoffice --headless --convert-to pdf "$DOCX_FILE"

          echo "Files after conversion:"
          ls -l

      - name: 🚀 Upload PDF back to S3
        run: |
          PDF_FILE=$(ls *.pdf)
          echo "Found PDF: $PDF_FILE"

          DOCX_NAME=${{ steps.find_latest.outputs.LATEST_DOC }}
          # Replacing .docx with .pdf in the same prefix
          PDF_TARGET="${DOCX_NAME%.docx}.pdf"

          echo "Re-uploading $PDF_FILE => s3://projectplace-dv-2025-x9a7b/$PDF_TARGET"
          aws s3 cp "$PDF_FILE" "s3://projectplace-dv-2025-x9a7b/$PDF_TARGET" \
            --content-type "application/pdf" \
            --content-disposition "attachment; filename=\"$(basename "$PDF_FILE")\""

          echo "✅ Done! The docx + pdf are both in s3://projectplace-dv-2025-x9a7b/actas/."
